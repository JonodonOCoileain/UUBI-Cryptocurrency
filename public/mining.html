<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUBI Mining System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .mining-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .coin-flip {
            animation: flip 1s ease-in-out;
        }
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }
        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-coins mr-2"></i>
                UUBI Mining System
            </h1>
            <p class="text-white opacity-90">Mine UUBI coins - 2/3 for UBI distribution, 1/3 for you</p>
        </div>

        <!-- Mining Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-6 text-center">
                <div class="text-3xl text-white mb-2">
                    <i class="fas fa-coins"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Your Balance</h3>
                <p class="text-2xl font-bold text-white" id="userBalance">0 UUBI</p>
            </div>
            
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-6 text-center">
                <div class="text-3xl text-white mb-2">
                    <i class="fas fa-globe"></i>
                </div>
                <h3 class="text-lg font-bold text-white">UBI Pool</h3>
                <p class="text-2xl font-bold text-white" id="ubiPool">0 UUBI</p>
            </div>
            
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-6 text-center">
                <div class="text-3xl text-white mb-2">
                    <i class="fas fa-hammer"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Mining Power</h3>
                <p class="text-2xl font-bold text-white" id="miningPower">1.0 H/s</p>
            </div>
            
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-6 text-center">
                <div class="text-3xl text-white mb-2">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Total Mined</h3>
                <p class="text-2xl font-bold text-white" id="totalMined">0 UUBI</p>
            </div>
        </div>

        <!-- Mining Interface -->
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
                    <i class="fas fa-hammer mr-2"></i>
                    Mining Console
                </h2>
                
                <!-- Mining Status -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Mining Progress</span>
                        <span class="text-sm text-gray-500" id="miningStatus">Ready to mine</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="progress-bar h-3 rounded-full" id="miningProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Mining Controls -->
                <div class="text-center mb-6">
                    <button id="startMiningBtn" class="bg-green-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-green-700 transition mr-4">
                        <i class="fas fa-play mr-2"></i>
                        Start Mining
                    </button>
                    <button id="stopMiningBtn" class="bg-red-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-red-700 transition" disabled>
                        <i class="fas fa-stop mr-2"></i>
                        Stop Mining
                    </button>
                </div>
                
                <!-- Mining Results -->
                <div id="miningResults" class="hidden">
                    <div class="bg-green-100 border border-green-200 rounded-lg p-4 mb-4">
                        <h3 class="text-lg font-bold text-green-800 mb-2">Mining Complete!</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-green-700">Coins mined:</span>
                                <span class="font-bold" id="coinsMined">0</span>
                            </div>
                            <div>
                                <span class="text-green-700">Your share (1/3):</span>
                                <span class="font-bold" id="yourShare">0</span>
                            </div>
                            <div>
                                <span class="text-green-700">UBI pool (2/3):</span>
                                <span class="font-bold" id="ubiShare">0</span>
                            </div>
                            <div>
                                <span class="text-green-700">Mining time:</span>
                                <span class="font-bold" id="miningTime">0s</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mining History -->
                <div class="mt-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Recent Mining Activity</h3>
                    <div id="miningHistory" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-gray-500 text-sm">No mining activity yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mining Info -->
        <div class="max-w-4xl mx-auto mt-8">
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-6">
                <h3 class="text-xl font-bold text-white mb-4">How UUBI Mining Works</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-white">
                    <div class="text-center">
                        <div class="text-4xl mb-2">‚õèÔ∏è</div>
                        <h4 class="font-bold mb-2">Mine Coins</h4>
                        <p class="text-sm opacity-90">Use your computing power to mine UUBI coins through proof-of-work</p>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl mb-2">üìä</div>
                        <h4 class="font-bold mb-2">2/3 to UBI Pool</h4>
                        <p class="text-sm opacity-90">Two-thirds of mined coins go to the Universal Basic Income distribution pool</p>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl mb-2">üí∞</div>
                        <h4 class="font-bold mb-2">1/3 to You</h4>
                        <p class="text-sm opacity-90">One-third of mined coins goes directly to your wallet as mining rewards</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mining system state
        let isMining = false;
        let miningInterval = null;
        let miningStartTime = null;
        let userBalance = 0;
        let ubiPool = 0;
        let totalMined = 0;
        let miningPower = 1.0;
        let miningHistory = [];

        // DOM elements
        const startBtn = document.getElementById('startMiningBtn');
        const stopBtn = document.getElementById('stopMiningBtn');
        const progressBar = document.getElementById('miningProgress');
        const miningStatus = document.getElementById('miningStatus');
        const miningResults = document.getElementById('miningResults');
        const userBalanceEl = document.getElementById('userBalance');
        const ubiPoolEl = document.getElementById('ubiPool');
        const totalMinedEl = document.getElementById('totalMined');
        const miningPowerEl = document.getElementById('miningPower');
        const miningHistoryEl = document.getElementById('miningHistory');

        // Mining configuration
        const MINING_DURATION = 10000; // 10 seconds
        const MINING_INTERVAL = 100; // Update every 100ms
        const BASE_MINING_POWER = 1.0;
        const DIFFICULTY_MULTIPLIER = 0.1; // Adjust difficulty

        // Start mining
        async function startMining() {
            if (isMining) return;
            
            try {
                // Start mining session on server
                const response = await fetch('/api/mining/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'demo-user-' + Date.now() // Demo user ID
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('Failed to start mining: ' + result.error, 'error');
                    return;
                }
                
                isMining = true;
                miningStartTime = Date.now();
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                miningStatus.textContent = 'Mining in progress...';
                miningResults.classList.add('hidden');
                
                // Start mining animation
                progressBar.classList.add('mining-animation');
                
                // Mining simulation
                let progress = 0;
                miningInterval = setInterval(() => {
                    progress += (100 / (MINING_DURATION / MINING_INTERVAL));
                    progressBar.style.width = Math.min(progress, 100) + '%';
                    
                    if (progress >= 100) {
                        completeMining();
                    }
                }, MINING_INTERVAL);
                
                showMessage('Mining started! Mining power: ' + result.data.miningPower.toFixed(1) + ' H/s', 'success');
                
            } catch (error) {
                console.error('Error starting mining:', error);
                showMessage('Failed to start mining: ' + error.message, 'error');
            }
        }

        // Stop mining
        function stopMining() {
            if (!isMining) return;
            
            isMining = false;
            clearInterval(miningInterval);
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            miningStatus.textContent = 'Mining stopped';
            progressBar.classList.remove('mining-animation');
            progressBar.style.width = '0%';
        }

        // Complete mining
        async function completeMining() {
            if (!isMining) return;
            
            try {
                // Complete mining session on server
                const response = await fetch('/api/mining/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'demo-user-' + Date.now() // Demo user ID
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('Failed to complete mining: ' + result.error, 'error');
                    return;
                }
                
                isMining = false;
                clearInterval(miningInterval);
                
                // Use server results
                const { totalCoins, userShare, ubiShare, miningTime, miningPower } = result.data;
                
                // Update balances
                userBalance += userShare;
                ubiPool += ubiShare;
                totalMined += totalCoins;
                
                // Update UI
                updateBalances();
                showMiningResults(totalCoins, userShare, ubiShare, miningTime);
                addToHistory(totalCoins, userShare, ubiShare, miningTime);
                
                // Reset controls
                startBtn.disabled = false;
                stopBtn.disabled = true;
                miningStatus.textContent = 'Mining complete! Ready to mine again';
                progressBar.classList.remove('mining-animation');
                progressBar.style.width = '0%';
                
                showMessage(`Mining complete! Mined ${totalCoins} coins (Your share: ${userShare}, UBI pool: ${ubiShare})`, 'success');
                
            } catch (error) {
                console.error('Error completing mining:', error);
                showMessage('Failed to complete mining: ' + error.message, 'error');
                
                // Reset controls even on error
                isMining = false;
                clearInterval(miningInterval);
                startBtn.disabled = false;
                stopBtn.disabled = true;
                miningStatus.textContent = 'Mining failed - Ready to try again';
                progressBar.classList.remove('mining-animation');
                progressBar.style.width = '0%';
            }
        }

        // Update balance displays
        function updateBalances() {
            userBalanceEl.textContent = userBalance + ' UUBI';
            ubiPoolEl.textContent = ubiPool + ' UUBI';
            totalMinedEl.textContent = totalMined + ' UUBI';
            miningPowerEl.textContent = miningPower.toFixed(1) + ' H/s';
        }

        // Show mining results
        function showMiningResults(totalCoins, userShare, ubiShare, miningTime) {
            document.getElementById('coinsMined').textContent = totalCoins;
            document.getElementById('yourShare').textContent = userShare;
            document.getElementById('ubiShare').textContent = ubiShare;
            document.getElementById('miningTime').textContent = miningTime.toFixed(1) + 's';
            
            miningResults.classList.remove('hidden');
            
            // Add coin flip animation
            const coins = document.querySelectorAll('.fa-coins');
            coins.forEach(coin => {
                coin.classList.add('coin-flip');
                setTimeout(() => coin.classList.remove('coin-flip'), 1000);
            });
        }

        // Add to mining history
        function addToHistory(totalCoins, userShare, ubiShare, miningTime) {
            const timestamp = new Date().toLocaleTimeString();
            const historyItem = {
                timestamp,
                totalCoins,
                userShare,
                ubiShare,
                miningTime
            };
            
            miningHistory.unshift(historyItem);
            if (miningHistory.length > 10) {
                miningHistory.pop();
            }
            
            updateHistoryDisplay();
        }

        // Update history display
        function updateHistoryDisplay() {
            if (miningHistory.length === 0) {
                miningHistoryEl.innerHTML = '<p class="text-gray-500 text-sm">No mining activity yet</p>';
                return;
            }
            
            miningHistoryEl.innerHTML = miningHistory.map(item => `
                <div class="bg-gray-100 rounded p-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${item.timestamp}</span>
                        <span class="text-green-600 font-bold">+${item.totalCoins} coins</span>
                    </div>
                    <div class="text-gray-600 mt-1">
                        You: ${item.userShare} UUBI | UBI Pool: ${item.ubiShare} UUBI | Time: ${item.miningTime.toFixed(1)}s
                    </div>
                </div>
            `).join('');
        }

        // Load mining data from server
        async function loadMiningData() {
            try {
                const response = await fetch('/api/mining/data');
                const result = await response.json();
                
                if (result.success) {
                    ubiPool = result.data.ubiPool;
                    totalMined = result.data.totalMined;
                    miningHistory = result.data.miningHistory || [];
                    updateBalances();
                    updateHistoryDisplay();
                    console.log('‚úÖ Mining data loaded from server');
                } else {
                    console.error('Failed to load mining data:', result.error);
                }
            } catch (error) {
                console.error('Error loading mining data:', error);
                // Fallback to localStorage
                const savedData = localStorage.getItem('uubiMiningData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    userBalance = data.userBalance || 0;
                    ubiPool = data.ubiPool || 0;
                    totalMined = data.totalMined || 0;
                    miningHistory = data.miningHistory || [];
                    updateBalances();
                    updateHistoryDisplay();
                }
            }
        }

        // Initialize mining system
        async function initializeMining() {
            console.log('üöÄ UUBI Mining System initialized');
            
            // Load data from server
            await loadMiningData();
            
            // Load local user balance
            const savedData = localStorage.getItem('uubiMiningData');
            if (savedData) {
                const data = JSON.parse(savedData);
                userBalance = data.userBalance || 0;
            }
            
            updateBalances();
            updateHistoryDisplay();
            
            // Event listeners
            startBtn.addEventListener('click', startMining);
            stopBtn.addEventListener('click', stopMining);
            
            // Auto-save data every 30 seconds
            setInterval(saveData, 30000);
            
            console.log('‚úÖ Mining system ready');
        }

        // Save data to localStorage
        function saveData() {
            const data = {
                userBalance,
                ubiPool,
                totalMined,
                miningHistory
            };
            localStorage.setItem('uubiMiningData', JSON.stringify(data));
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeMining);
    </script>
</body>
</html>
