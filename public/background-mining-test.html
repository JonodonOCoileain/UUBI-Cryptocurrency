<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUBI Background Mining Test</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-hammer mr-2"></i>
                UUBI Background Mining Test
            </h1>
            <p class="text-white opacity-90">Test mining that continues when browser is hidden</p>
        </div>

        <!-- Test Instructions -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <i class="fas fa-info-circle mr-2"></i>
                How to Test Background Mining
            </h2>
            
            <div class="space-y-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <span class="text-blue-600 font-bold">1</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Start Mining</h3>
                        <p class="text-gray-600">Click "Start Background Mining" below</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <span class="text-blue-600 font-bold">2</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Hide Browser</h3>
                        <p class="text-gray-600">Minimize the browser window or switch to another tab</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <span class="text-blue-600 font-bold">3</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Check Notifications</h3>
                        <p class="text-gray-600">You should receive browser notifications when blocks are mined</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <span class="text-blue-600 font-bold">4</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Return to Tab</h3>
                        <p class="text-gray-600">Come back to see updated mining statistics</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mining Controls -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <i class="fas fa-cogs mr-2"></i>
                Mining Controls
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label for="testMinerAddress" class="block text-sm font-medium text-gray-700 mb-2">Miner Address</label>
                    <input type="text" id="testMinerAddress" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="Enter your miner address" value="">
                </div>
                
                <div class="flex space-x-4">
                    <button id="testStartMining" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition">
                        <i class="fas fa-play mr-2"></i>
                        Start Background Mining
                    </button>
                    <button id="testStopMining" class="bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition" disabled>
                        <i class="fas fa-stop mr-2"></i>
                        Stop Mining
                    </button>
                </div>
            </div>
        </div>

        <!-- Mining Status -->
        <div id="testMiningStatus" class="bg-white rounded-lg shadow-lg p-8 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <i class="fas fa-chart-line mr-2"></i>
                Mining Status
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="testBlocksMined">0</div>
                    <div class="text-sm text-gray-600">Blocks Mined</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="testUserBalance">0</div>
                    <div class="text-sm text-gray-600">Your Balance (UUBI)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600" id="testUbiPool">0</div>
                    <div class="text-sm text-gray-600">UBI Pool (UUBI)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-orange-600" id="testHashrate">0</div>
                    <div class="text-sm text-gray-600">Hashrate (H/s)</div>
                </div>
            </div>
        </div>

        <!-- Mining History -->
        <div id="testMiningHistory" class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <i class="fas fa-history mr-2"></i>
                Mining History
            </h2>
            
            <div id="testHistoryList" class="space-y-2 max-h-64 overflow-y-auto">
                <p class="text-gray-500 text-center py-4">No mining history yet</p>
            </div>
        </div>
    </div>

    <script>
        // Test mining functionality
        let testMiningWorker = null;
        let testMiningState = {
            isMining: false,
            blocksMined: 0,
            userBalance: 0,
            ubiPool: 0,
            hashrate: 0
        };

        // Initialize test page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Initializing background mining test...');
            
            // Set default miner address
            document.getElementById('testMinerAddress').value = 'test-miner-' + Date.now();
            
            // Initialize Web Worker
            initializeTestWorker();
            
            // Setup event listeners
            document.getElementById('testStartMining').addEventListener('click', startTestMining);
            document.getElementById('testStopMining').addEventListener('click', stopTestMining);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        function initializeTestWorker() {
            try {
                testMiningWorker = new Worker('/mining-worker.js');
                
                testMiningWorker.onmessage = function(e) {
                    handleTestWorkerMessage(e.data);
                };
                
                testMiningWorker.onerror = function(error) {
                    console.error('‚ùå Test mining worker error:', error);
                };
                
                console.log('‚úÖ Test mining worker initialized');
            } catch (error) {
                console.error('‚ùå Failed to initialize test mining worker:', error);
            }
        }

        function handleTestWorkerMessage(data) {
            switch (data.type) {
                case 'miningStarted':
                    console.log('‚úÖ Test mining started');
                    updateTestUI(true);
                    break;
                    
                case 'miningStopped':
                    console.log('üõë Test mining stopped');
                    updateTestUI(false);
                    break;
                    
                case 'blockMined':
                    handleTestBlockMined(data.data);
                    break;
                    
                case 'statsUpdate':
                    updateTestStats(data.data);
                    break;
            }
        }

        function startTestMining() {
            if (testMiningState.isMining) return;
            
            const minerAddress = document.getElementById('testMinerAddress').value || 'test-miner-' + Date.now();
            
            testMiningState.isMining = true;
            
            testMiningWorker.postMessage({
                action: 'startMining',
                data: { minerAddress: minerAddress }
            });
            
            console.log('üöÄ Test mining started');
        }

        function stopTestMining() {
            if (!testMiningState.isMining) return;
            
            testMiningState.isMining = false;
            
            testMiningWorker.postMessage({ action: 'stopMining' });
            
            console.log('üõë Test mining stopped');
        }

        function updateTestUI(isMining) {
            const startBtn = document.getElementById('testStartMining');
            const stopBtn = document.getElementById('testStopMining');
            const statusDiv = document.getElementById('testMiningStatus');
            
            startBtn.disabled = isMining;
            stopBtn.disabled = !isMining;
            statusDiv.classList.toggle('hidden', !isMining);
        }

        function handleTestBlockMined(blockData) {
            testMiningState.blocksMined = blockData.blockNumber;
            testMiningState.userBalance = blockData.userBalance;
            testMiningState.ubiPool = blockData.ubiPool;
            testMiningState.hashrate = blockData.hashrate;
            
            updateTestStats(testMiningState);
            addTestHistoryEntry(blockData);
            
            // Show notification
            showTestNotification(
                `Block #${blockData.blockNumber} Mined!`,
                `+${blockData.minerReward} UUBI earned`
            );
        }

        function updateTestStats(data) {
            document.getElementById('testBlocksMined').textContent = data.blocksMined || 0;
            document.getElementById('testUserBalance').textContent = data.userBalance || 0;
            document.getElementById('testUbiPool').textContent = data.ubiPool || 0;
            document.getElementById('testHashrate').textContent = (data.hashrate || 0).toLocaleString();
        }

        function addTestHistoryEntry(blockData) {
            const historyList = document.getElementById('testHistoryList');
            
            if (historyList.querySelector('.text-gray-500')) {
                historyList.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = 'bg-gray-50 p-3 rounded border-l-4 border-green-500';
            entry.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium text-sm">Block #${blockData.blockNumber} Mined</p>
                        <p class="text-xs text-gray-600">${new Date(blockData.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-green-600">+${blockData.minerReward} UUBI</p>
                        <p class="text-xs text-gray-600">${blockData.hashrate.toLocaleString()} H/s</p>
                    </div>
                </div>
            `;
            
            historyList.insertBefore(entry, historyList.firstChild);
            
            // Keep only last 10 entries
            while (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        function showTestNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/favicon.ico',
                    tag: 'uubi-test-mining'
                });
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (testMiningWorker) {
                testMiningWorker.terminate();
            }
        });
    </script>
</body>
</html>
